
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order</title>
<style>
* {box-sizing:border-box;font-family:Arial, sans-serif;}
body {margin:0;background:#f7f7f7;}
.wrapper {max-width:420px;margin:auto;padding:16px;background:#fff;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.header {font-size:20px;font-weight:700;margin-bottom:20px;text-align:center;color:#333;}
.product {display:flex;gap:10px;margin:14px 0;position:relative;background:#fafafa;padding:10px;border-radius:8px;align-items:center;}
.product img {width:70px;height:70px;border-radius:6px;object-fit:cover;}
.qty-badge {position:absolute;left:-8px;top:-8px;width:22px;height:22px;border-radius:50%;background:#007bff;color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;}
.info {flex:1}
.info strong {display:block;color:#333;}
.box {border:1px solid #ddd;border-radius:8px;padding:12px;margin:14px 0;background:#f9f9f9;}
.row {display:flex;justify-content:space-between;margin:6px 0;font-weight:600;color:#555;}
label {font-weight:700;margin-top:12px;display:block;color:#444;}
.input {display:flex;align-items:center;border:1px solid #ccc;border-radius:6px;overflow:hidden;margin-top:6px}
.input span {padding:10px;background:#eee}
.input input {border:none;flex:1;padding:10px;font-size:15px}
.radio {margin:14px 0; display:flex; gap:20px; align-items:center;}
.radio label {display:flex;align-items:center;gap:6px;font-weight:600;color:#333;}
.upload-box {display:none;margin-top:10px;padding:12px;border:1px dashed #007bff;border-radius:8px;background:#f0f8ff;text-align:center;color:#007bff;font-size:14px;}
.upload-box input[type="file"] {margin-top:10px;}
button {width:100%;padding:14px;border:none;border-radius:25px;background:#007bff;color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:0.3s;}
button:hover {background:#0056b3;}
.finished {color:green;font-weight:bold;}
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">Please fill in the form to order</div>

  <div id="products"></div>

  <div class="box">
    <div class="row"><span>Subtotal</span><strong id="subtotal">ETB 0</strong></div>
    <div class="row"><span>Total</span><strong id="total">ETB 0</strong></div>
  </div>

  <label>Full Name*</label>
  <div class="input"><span>游녻</span><input id="name" placeholder="Enter your full name"></div>

  <label>Phone*</label>
  <div class="input"><span>游</span><input id="phone" placeholder="Enter your phone number"></div>

  <div class="radio">
    <label><input type="radio" name="pay" value="Cash" checked> Cash</label>
    <label><input type="radio" name="pay" value="Transfer"> Transfer</label>
  </div>

  <div class="upload-box" id="uploadBox">
    <div>Please upload your transfer screenshot here</div>
    <input type="file" id="proof" accept="image/*">
  </div>

  <br>
  <button onclick="submitOrder()">ORDER</button>
</div>

<script>
/* For signup or logout */
fetch('check_session.php')
    .then(response => response.json())
    .then(data => {
        const authLink = document.getElementById('auth-link');
        const authText = document.getElementById('auth-text');
        if (data && data.loggedIn) {
            authLink.href = "javascript:void(0)";
            authLink.onclick = function() {
                if(confirm("Are you sure you want to log out?")) {
                    window.location.href = 'logout.php';
                }
            };
            authText.innerText = "Logout (" + data.name + ")";
        }
    })
    .catch(err => console.error("Session check failed", err));

const CART_KEY = "cartItems";
const cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
const productsDiv = document.getElementById("products");
let subtotal = 0;
let isLoggedIn = false;

/* CHECK SESSION FOR NAME PRE-FILL */
fetch('check_session.php')
    .then(response => response.json())
    .then(data => {
        if (data.loggedIn) {
            isLoggedIn = true;
            if(!document.getElementById('name').value) {
                document.getElementById('name').value = data.name;
            }
        }
    });

/* RENDER PRODUCTS ON PAGE */
if(productsDiv) {
    if(cart.length === 0){
        productsDiv.innerHTML = "<p>No products in your bag</p>";
    }
    cart.forEach(p=>{
        subtotal += p.price * p.qty;
        productsDiv.innerHTML += `
            <div class="product">
                <div class="qty-badge">${p.qty}</div>
                <img src="${p.image || p.img || 'https://via.placeholder.com/150'}">
                <div class="info">
                    <strong>${p.name}</strong>
                    ETB ${(p.price * p.qty).toFixed(2)}
                </div>
            </div>`;
    });
    document.getElementById("subtotal").innerText = "ETB " + subtotal.toFixed(2);
    document.getElementById("total").innerText = "ETB " + subtotal.toFixed(2);
}

/* PAYMENT TOGGLE SHOW UPLOADER */
document.querySelectorAll("input[name='pay']").forEach(r=>{
    r.addEventListener("change",()=>{
        const uploadBox = document.getElementById("uploadBox");
        if(r.value === "Transfer" && r.checked){
            uploadBox.style.display = "block";
        } else {
            uploadBox.style.display = "none";
        }
    });
});

function smallCloudinary(url) {
    if(!url) return "https://via.placeholder.com/150";
    return url.replace("/upload/", "/upload/w_300,h_300,c_fit,q_60,f_jpg/");
}

/* THE ORDER BUTTON LOGIC */
function handleOrderClick() {
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    if(!name || !phone){
        alert("Please fill name and phone number first.");
        return;
    }
    if (isLoggedIn) {
        submitOrder(); 
    } else {
        if (confirm("Wait! You are not logged in. Would you like to login now?")) {
            window.location.href = "login.html"; 
        } else {
            alert("Ordering is only allowed for registered members.");
        }
    }
}

async function submitOrder() {
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const payment = document.querySelector("input[name='pay']:checked").value;
    const proof = document.getElementById("proof");

    if(!name || !phone){ alert("Please fill name and phone"); return; }
    if(payment === "Transfer" && !proof.files.length){ alert("Please upload transfer proof"); return; }

    const BOT_TOKEN = "8310816737:AAEIrdAPb4IXUwTl4fUeM-9k2qTE2jQmmuk";
    const CHAT_ID = "5335234629";
    const API = `https://api.telegram.org/bot${BOT_TOKEN}`;

    try {
        /* 1. SEND TO EMAIL (order.php) */
        const emailData = new FormData();
        emailData.append('name', name);
        emailData.append('phone', phone);
        emailData.append('paymentMethod', payment);
        emailData.append('cartData', JSON.stringify(cart));
        emailData.append('totalPrice', subtotal);
        fetch('order.php', { method: 'POST', body: emailData });

        /* 2. TELEGRAM: SEND CUSTOMER INFO */
        await fetch(`${API}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                chat_id: CHAT_ID,
                text: `游릭NEW ORDER游릭\n游녻 Name: ${name}\n游 Phone: ${phone}\n游눱 Payment: ${payment}`
            })
        });

        /* 3. TELEGRAM: SEND EACH PRODUCT INDIVIDUALLY WITH PHOTO */
        for (const p of cart) {
            // Send Product Text
            await fetch(`${API}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: `游닍 Product:\n游 Name: ${p.name}\n游댝 Qty: ${p.qty}\n游눳 Price: ETB ${p.price}\n游눯 Subtotal: ETB ${(p.price * p.qty).toFixed(2)}`
                })
            });

            // Send Product Image
            const imgUrl = smallCloudinary(p.image || p.img);
            await fetch(`${API}/sendPhoto`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    photo: imgUrl,
                    caption:` ${p.name} x${p.qty} = ETB ${(p.price * p.qty).toFixed(2)}`
                })
            });
        }

        /* 4. TELEGRAM: SEND TRANSFER PROOF */
        if (payment === "Transfer" && proof.files.length) {
            const form = new FormData();
            form.append("chat_id", CHAT_ID);
            form.append("document", proof.files[0]);
            form.append("caption", "游눱 Transfer Proof from " + name);
            await fetch(`${API}/sendDocument`, { method: "POST", body: form });
        }

        /* 5. TELEGRAM: SEND TOTAL + FINISHED */
        await fetch(`${API}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                chat_id: CHAT_ID,
                text: `游눯 TOTAL ORDER AMOUNT: ETB ${subtotal.toFixed(2)}\n九九Finished九九`
            })
        });

        localStorage.removeItem(CART_KEY);
        alert("Success! Your order has been sent.");
        window.location.href = "success.html";

    } catch (e) {
        console.error(e);
        alert("Error sending order.");
    }
}

// Bind order button
const orderBtn = document.querySelector(".btn-order");
if(orderBtn) orderBtn.onclick = handleOrderClick;
</script>
</body>
</html>


