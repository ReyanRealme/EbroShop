
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order</title>
<style>
* {box-sizing:border-box;font-family:Arial, sans-serif;}
body {margin:0;background:#f7f7f7;}
.wrapper {max-width:420px;margin:auto;padding:16px;background:#fff;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.header {font-size:20px;font-weight:700;margin-bottom:20px;text-align:center;color:#333;}
.product {display:flex;gap:10px;margin:14px 0;position:relative;background:#fafafa;padding:10px;border-radius:8px;align-items:center;}
.product img {width:70px;height:70px;border-radius:6px;object-fit:cover;}
.qty-badge {position:absolute;left:-8px;top:-8px;width:22px;height:22px;border-radius:50%;background:#007bff;color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center;}
.info {flex:1}
.info strong {display:block;color:#333;}
.box {border:1px solid #ddd;border-radius:8px;padding:12px;margin:14px 0;background:#f9f9f9;}
.row {display:flex;justify-content:space-between;margin:6px 0;font-weight:600;color:#555;}
label {font-weight:700;margin-top:12px;display:block;color:#444;}
.input {display:flex;align-items:center;border:1px solid #ccc;border-radius:6px;overflow:hidden;margin-top:6px}
.input span {padding:10px;background:#eee}
.input input {border:none;flex:1;padding:10px;font-size:15px}
.radio {margin:14px 0; display:flex; gap:20px; align-items:center;}
.radio label {display:flex;align-items:center;gap:6px;font-weight:600;color:#333;}
.upload-box {display:none;margin-top:10px;padding:12px;border:1px dashed #007bff;border-radius:8px;background:#f0f8ff;text-align:center;color:#007bff;font-size:14px;}
.upload-box input[type="file"] {margin-top:10px;}
button {width:100%;padding:14px;border:none;border-radius:25px;background:#007bff;color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:0.3s;}
button:hover {background:#0056b3;}
.finished {color:green;font-weight:bold;}
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">Please fill in the form to order</div>

  <div id="products"></div>

  <div class="box">
    <div class="row"><span>Subtotal</span><strong id="subtotal">ETB 0</strong></div>
    <div class="row"><span>Total</span><strong id="total">ETB 0</strong></div>
  </div>

  <label>Full Name*</label>
  <div class="input"><span>ðŸ‘¤</span><input id="name" placeholder="Enter your full name"></div>

  <label>Phone*</label>
  <div class="input"><span>ðŸ“ž</span><input id="phone" placeholder="Enter your phone number"></div>

  <div class="radio">
    <label><input type="radio" name="pay" value="Cash" checked> Cash</label>
    <label><input type="radio" name="pay" value="Transfer"> Transfer</label>
  </div>

  <div class="upload-box" id="uploadBox">
    <div>Please upload your transfer screenshot here</div>
    <input type="file" id="proof" accept="image/*">
  </div>

  <br>
  <button onclick="submitOrder()">ORDER</button>
</div>


<script>
    /* 1. AUTH & SESSION CHECK */
    let isLoggedIn = false;
    fetch('check_session.php')
        .then(response => response.json())
        .then(data => {
            const authLink = document.getElementById('auth-link');
            const authText = document.getElementById('auth-text');
            if (data && data.loggedIn) {
                isLoggedIn = true;
                if(document.getElementById('name')) {
                    document.getElementById('name').value = data.name;
                }
                if(authLink && authText) {
                    authLink.href = "javascript:void(0)";
                    authLink.onclick = function() {
                        if(confirm("Are you sure you want to log out?")) {
                            window.location.href = 'logout.php';
                        }
                    };
                    authText.innerText = "Logout (" + data.name + ")";
                }
            }
        }).catch(err => console.log("Session skip"));

    /* 2. CART LOADING & RENDERING */
    const CART_KEY = "cartItems";
    const cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
    const productsDiv = document.getElementById("products");
    let subtotal = 0;

    if(productsDiv) {
        if(cart.length === 0){
            productsDiv.innerHTML = "<p style='text-align:center;'>No products in your bag</p>";
        }
        cart.forEach(p => {
            subtotal += p.price * p.qty;
            productsDiv.innerHTML += `
                <div class="product">
                    <div class="qty-badge">${p.qty}</div>
                    <img src="${p.image || p.img || 'https://via.placeholder.com/150'}">
                    <div class="info">
                        <strong>${p.name}</strong>
                        ETB ${(p.price * p.qty).toFixed(2)}
                    </div>
                </div>`;
        });
        document.getElementById("subtotal").innerText = "ETB " + subtotal.toFixed(2);
        document.getElementById("total").innerText = "ETB " + subtotal.toFixed(2);
    }

    /* 3. PAYMENT TOGGLE */
    document.querySelectorAll("input[name='pay']").forEach(r => {
        r.addEventListener("change", () => {
            const uploadBox = document.getElementById("uploadBox");
            if(uploadBox) {
                uploadBox.style.display = (r.value === "Transfer" && r.checked) ? "block" : "none";
            }
        });
    });

    function smallCloudinary(url) {
        if(!url) return "https://via.placeholder.com/150";
        if(url.includes("cloudinary.com")) {
            return url.replace("/upload/", "/upload/w_300,h_300,c_fit,q_60,f_jpg/");
        }
        return url;
    }

    /* 4. ORDER SUBMISSION (Telegram + Email) */
    async function submitOrder() {
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const payment = document.querySelector("input[name='pay']:checked").value;
        const proof = document.getElementById("proof");

        if (payment === "Transfer" && (!proof.files || !proof.files.length)) {
            alert("Please upload your transfer proof.");
            return;
        }

        const BOT_TOKEN = "8310816737:AAEIrdAPb4IXUwTl4fUeM-9k2qTE2jQmmuk";
        const CHAT_ID = "5335234629";
        const API = `https://api.telegram.org/bot${BOT_TOKEN}`;

        // --- PART A: SEND EMAIL VIA BREVO ---
        const emailForm = new FormData();
        emailForm.append('name', name);
        emailForm.append('phone', phone);
        emailForm.append('paymentMethod', payment);
        emailForm.append('cartData', JSON.stringify(cart));
        emailForm.append('totalPrice', subtotal);
        fetch('order.php', { method: 'POST', body: emailForm }).catch(e => console.log("Email error"));
        try {
            // --- PART B: TELEGRAM CUSTOMER INFO ---
            await fetch(`${API}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text: `ðŸŸ¢NEW ORDERðŸŸ¢\nðŸ‘¤ Name: ${name}\nðŸ“ž Phone: ${phone}\nðŸ’³ Payment: ${payment}`
                })
            });

            // --- PART C: TELEGRAM INDIVIDUAL PRODUCTS + PHOTOS ---
            for (const p of cart) {
                // 1. Text Info
                await fetch(`${API}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: `ðŸ“¦ Product:\nðŸ§¾ Name: ${p.name}\nðŸ”¢ Qty: ${p.qty}\nðŸ’µ Price: ETB ${p.price}\nðŸ’° Subtotal: ETB ${(p.price * p.qty).toFixed(2)}`
                    })
                });
                // 2. Product Photo
                await fetch(`${API}/sendPhoto`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        photo: smallCloudinary(p.image || p.img),
                        caption: `${p.name} (x${p.qty})`
                    })
                });
            }

            // --- PART D: TELEGRAM TRANSFER PROOF ---
            if (payment === "Transfer" && proof.files.length) {
                const form = new FormData();
                form.append("chat_id", CHAT_ID);
                form.append("document", proof.files[0]);
                form.append("caption", "ðŸ’³ Transfer Receipt: " + name);
                await fetch(`${API}/sendDocument`, { method: "POST", body: form });
            }

            // --- PART E: TELEGRAM TOTAL ---
            await fetch(`${API}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: CHAT_ID,
                    text:` ðŸ’° TOTAL ORDER AMOUNT: ETB ${subtotal.toFixed(2)}\nâœ…âœ…Finishedâœ…âœ…`
                })
            });

            localStorage.removeItem(CART_KEY);
            alert("Order Placed Successfully!");
            window.location.href = "thankyou.html";

        } catch (error) {
            console.error(error);
            alert("Success! Order processed.");
            window.location.href = "thankyou.html";
        }
    }

    function handleOrderClick() {
        const name = document.getElementById("name").value.trim();
        const phone = document.getElementById("phone").value.trim();
        if(!name || !phone){ alert("Fill details first."); return; }
        if (isLoggedIn) { submitOrder(); } 
        else { if(confirm("Login now?")) window.location.href = "login.html"; }
    }

    const mainBtn = document.querySelector(".btn-order");
    if(mainBtn) mainBtn.onclick = handleOrderClick;

    /* 5. SIDE MENU & SEARCH LOGIC (Original) */
    (function(){
        const hamburger = document.getElementById("hamburgerBtn");
        const sideMenu = document.getElementById("sideMenu");
        const menuOverlay = document.getElementById("menuOverlay");
        const badge = document.getElementById("cartBadge");

        function updateBadge(){
            const c = JSON.parse(localStorage.getItem(CART_KEY)) || [];
            const total = c.reduce((s,i)=> s + (i.qty||0), 0);
            if(badge) {
                badge.style.display = total > 0 ? "flex" : "none";
                badge.innerText = total;
            }
        }
        updateBadge();

        if(hamburger) hamburger.onclick = () => { sideMenu.style.left = "0"; menuOverlay.style.display = "block"; };
        if(menuOverlay) menuOverlay.onclick = () => { sideMenu.style.left = "-320px"; menuOverlay.style.display = "none"; };
    })();
    /* 6. FAQ & SCROLL LOGIC */
    function toggleSection(id, header) {
        const content = document.getElementById(id);
        const icon = header.querySelector('.toggle');
        content.classList.toggle('hidden');
        icon.textContent = content.classList.contains('hidden') ? '+' : 'âˆ’';
    }

    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.classList.add('visible');
        });
    }, { threshold: 0.3 });
    document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
</script>
</body>
</html>


